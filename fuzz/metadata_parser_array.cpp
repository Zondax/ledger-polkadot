#include <cassert>
#include <cstdint>
#include <cstdio>
#include <string>

#include "hexutils.h"
#include "metadata_parser.h"
#include "metadata_types.h"
#include "parser_common.h"
#include "parser_impl.h"
#include "substrate_types.h"

#ifdef NDEBUG
#error "This fuzz target won't work correctly with NDEBUG defined, which will cause asserts to be eliminated"
#endif

using std::size_t;

const std::string metadataPolkadotTreasurySpend =
    "cc000341000000030102082873705f72756e74696d65384d756c74695369676e6174757265011c456432353531390400169d0101486564323535313"
    "93a3a5369676e617475726500c902082873705f72756e74696d65384d756c74695369676e6174757265011c53723235353139040016cd0201487372"
    "32353531393a3a5369676e617475726504c902082873705f72756e74696d65384d756c74695369676e617475726501144563647361040016d102014"
    "065636473613a3a5369676e617475726508c9020c1c73705f636f72651c73723235353139245369676e617475726500040016a10101205b75383b20"
    "36345dcd020c1c73705f636f7265146563647361245369676e6174757265000400160102017c5b75383b205349474e41545552455f53455249414c4"
    "95a45445f53495a455dd10210306672616d655f73797374656d28657874656e73696f6e733c636865636b5f6d6f7274616c69747938436865636b4d"
    "6f7274616c697479000400168506010c4572618106102873705f72756e74696d651c67656e657269630c6572610c45726101204d6f7274616c34390"
    "4000300c4850610306672616d655f73797374656d28657874656e73696f6e732c636865636b5f6e6f6e636528436865636b4e6f6e63650004001101"
    "20543a3a4e6f6e63658906086870616c6c65745f7472616e73616374696f6e5f7061796d656e74604368617267655472616e73616374696f6e50617"
    "96d656e7400040013013042616c616e63654f663c543e8d060c1c73705f636f72651863727970746f2c4163636f756e744964333200040016040120"
    "5b75383b2033325d000003200000000304083c7072696d69746976655f74797065731048323536000400160401205b75383b2033325d0c000203100"
    "c5c706f6c6b61646f745f72756e74696d655f636f6d6d6f6e14696d706c735c56657273696f6e65644c6f63617461626c6541737365740108563308"
    "01206c6f636174696f6e1648015878636d3a3a76333a3a4d756c74694c6f636174696f6e012061737365745f69641668014078636d3a3a76333a3a4"
    "17373657449640c44102c73746167696e675f78636d087633346d756c74696c6f636174696f6e344d756c74694c6f636174696f6e0008011c706172"
    "656e747303010875380120696e746572696f72164c01244a756e6374696f6e7348100c78636d087633246a756e6374696f6e73244a756e6374696f6"
    "e73010858361800165001204a756e6374696f6e00165001204a756e6374696f6e00165001204a756e6374696f6e00165001204a756e6374696f6e00"
    "165001204a756e6374696f6e00165001204a756e6374696f6e184c100c78636d087633206a756e6374696f6e204a756e6374696f6e0124506172616"
    "36861696e040011010c7533320050100c78636d087633206a756e6374696f6e204a756e6374696f6e01384163636f756e74496e646578363408011c"
    "6e6574776f726b165401444f7074696f6e3c4e6574776f726b49643e0114696e64657812010c7536340850100c78636d087633206a756e6374696f6"
    "e204a756e6374696f6e01304163636f756e744b6579323008011c6e6574776f726b165401444f7074696f6e3c4e6574776f726b49643e010c6b6579"
    "165c01205b75383b2032305d0c50100c78636d087633206a756e6374696f6e204a756e6374696f6e013c476c6f62616c436f6e73656e73757304001"
    "65801244e6574776f726b4964245004184f7074696f6e01104e6f6e6500005404184f7074696f6e0110536f6d6504001658000454100c78636d0876"
    "33206a756e6374696f6e244e6574776f726b49640124427947656e657369730400160401205b75383b2033325d0058100c78636d087633206a756e6"
    "374696f6e244e6574776f726b496401184279466f726b080130626c6f636b5f6e756d62657206010c7536340128626c6f636b5f6861736816040120"
    "5b75383b2033325d0458000314000000035c100c78636d087633286d756c746961737365741c4173736574496401204162737472616374040016040"
    "1205b75383b2033325d0468102c73746167696e675f78636d087634206c6f636174696f6e204c6f636174696f6e0008011c706172656e7473030108"
    "75380120696e746572696f72167001244a756e6374696f6e736c102c73746167696e675f78636d087634246a756e6374696f6e73244a756e6374696"
    "f6e73010858380400169c01484172633c5b4a756e6374696f6e3b20385d3e2070102c73746167696e675f78636d087634206a756e6374696f6e204a"
    "756e6374696f6e01384163636f756e74496e646578363408011c6e6574776f726b167c01444f7074696f6e3c4e6574776f726b49643e0114696e646"
    "57812010c7536340878102c73746167696e675f78636d087634206a756e6374696f6e204a756e6374696f6e013850616c6c6574496e7374616e6365"
    "040003010875381078102c73746167696e675f78636d087634206a756e6374696f6e204a756e6374696f6e013047656e6572616c496e64657804001"
    "30110753132381478102c73746167696e675f78636d087634206a756e6374696f6e204a756e6374696f6e012847656e6572616c4b65790801186c65"
    "6e6774680301087538011064617461160401205b75383b2033325d1878102c73746167696e675f78636d087634206a756e6374696f6e204a756e637"
    "4696f6e01244f6e6c794368696c64001c78102c73746167696e675f78636d087634206a756e6374696f6e204a756e6374696f6e013c476c6f62616c"
    "436f6e73656e7375730400168001244e6574776f726b4964247804184f7074696f6e0110536f6d650400168000047c102c73746167696e675f78636"
    "d087634206a756e6374696f6e244e6574776f726b49640124427947656e657369730400160401205b75383b2033325d0080102c73746167696e675f"
    "78636d087634206a756e6374696f6e244e6574776f726b49640118526f636f636f001480102c73746167696e675f78636d087634206a756e6374696"
    "f6e244e6574776f726b4964012c426974636f696e4361736800248000030800000016789c080c78636d4456657273696f6e65644c6f636174696f6e"
    "010856340400166c013076343a3a4c6f636174696f6e10a40840706f6c6b61646f745f72756e74696d652c52756e74696d6543616c6c01205472656"
    "173757279040016b50101b50173656c663a3a73705f6170695f68696464656e5f696e636c756465735f636f6e7374727563745f72756e74696d653a"
    "3a68696464656e5f696e636c7564653a3a64697370617463680a3a3a43616c6c61626c6543616c6c466f723c54726561737572792c2052756e74696"
    "d653e4cc80c2873705f72756e74696d65306d756c746961646472657373304d756c746941646472657373010849640400160001244163636f756e74"
    "49640019010c2873705f72756e74696d65306d756c746961646472657373304d756c7469416464726573730114496e64657804001501304163636f7"
    "56e74496e6465780419010c2873705f72756e74696d65306d756c746961646472657373304d756c746941646472657373010c52617704001610011c"
    "5665633c75383e0819010c2873705f72756e74696d65306d756c746961646472657373304d756c74694164647265737301244164647265737333320"
    "400160401205b75383b2033325d0c19010c2873705f72756e74696d65306d756c746961646472657373304d756c7469416464726573730124416464"
    "7265737332300400165c01205b75383b2032305d1019010c1c73705f636f72651c65643235353139245369676e617475726500040016a10101205b7"
    "5383b2036345d9d0100034000000003a1010c3c70616c6c65745f74726561737572791870616c6c65741043616c6c01147370656e64100128617373"
    "65745f6b696e6416440144426f783c543a3a41737365744b696e643e0118616d6f756e74130150417373657442616c616e63654f663c542c20493e0"
    "12c62656e656669636961727916a40178426f783c42656e65666963696172794c6f6f6b75704f663c542c20493e3e012876616c69645f66726f6d16"
    "b90101644f7074696f6e3c426c6f636b4e756d626572466f723c543e3e14b50104184f7074696f6e01104e6f6e650000b901cc14080000950800009"
    "6080000970800009808000099080000c80b0000fa0b0000c90c0000ca0c0000650600006606000068060000690600007e0600008006000087060000"
    "8a0600008c0600008d0600009306000094060000950600009606000097060000a1060000b2060000b3060000bc060000c0060000c2060000c306000"
    "0c4060000c5060000c7060000c9060000ca060000cf060000d3060000db060000df0600001407000065070000660700006707000068070000690700"
    "00be070000bf070000c9070000cd070000a5016789ced43a0367885ff3078f5e2fc7a4f410e0de25fc61592fd571a3ddd0992308c0aeb6a568a4d74"
    "f481cbb138a78dfb713c343c20a1050c5235b1ad89073b2cb142cc9a3b3bdfcd9ed0e511c36917ae671cc251a6d7fd3d5f85d9a5e7c3fa5c3f90b25"
    "5b14f7de7904a8a82d6f793db29ea554a3a72d5d7cc8ce6d7737bc0173743df5f2da9aabcea1dd2dbd238bddc043e8ea38535ab63a7992bc9684974"
    "7568b99743425c3b7952dce707b4f9a80fa40118ef72aaf9dc3f5395ae644511d49fed1b2ae921ef2b57e8ef1f97884c95cb192eb72aff9121b362d"
    "353c7607b20d63fcfc9db22e37fbd115d20c0a95bcff4e1a2d198c2c46f56cddbb36c1e3337096be7ded3a487b812f391541f80b87b4a6e5b02e654"
    "7f6e87f41a60199a4930eaf1a762ca945720736ba47951700d451e5a5632995a575be272e8299e1210f02304678945b1d3661789ee3b3c94b09cb82"
    "10d6997b610086b2f768f914314cbd4b0da441e1d200352230239b6bb43a187e22d1ee788737c0fb38e06a84ae1d7465e3499cb65f80604723105a3"
    "c752946df8f689de24809d9a32e785697c476acf0de41e9616da3b42a902176dd8708edd4fded453de1482673dd739e1126551d7657b1d4c973a62a"
    "fb0fb87ca4023059f8778235367e3664ffb34c6d651737c1c29bf8b17a01b7c6524a998d958d03052f7294aaceaa07c0ce2ccc35cd08872f436caf9"
    "d39af986a70fe2923b8a433472c431b18b01a3801d02f187102464cda4c9376ec604df012735ff23739dfc232e0daade3f6e438786f035cf6c8a343"
    "efefbf92dfbdf739ca2cb82d84a288bace231a23497fb059ba78dde5d7b41ea49145f8878601aca7c0aed379d9dab0fdf35d4c262dff0664845b741"
    "fff26953a5d2c7a489d907b186551a787f47de0fd1d606dfdb6d0c31b568b1e6d21caec884c91aa88564aff5e9c8ee47b3753091ee7fe59d3d68b27"
    "9dee5d8c28cdd86428a5f1789a440bf1f887e14bc68dca767b0b76b9e253c7f7e4abaf9fcfa4dbcc7afad17d262fc5c66aa415896375cdd1a2834a6"
    "e586f06edbecb13542d40cc539a1bbd622c4c56ca497887041aacdb1d7d7df5ec072b40de0e605c25a52bbbd8d6cbc0a09f9ffebc06aa7068d99827"
    "6be8961d73b6cb3220840f43d41cdb177c2cecaa67fcd1bbbfbc009ab5775e4dfeb7ca1888336266068f6dbd468fcdaa0d75efcf582ffc8b1d5a7bd"
    "37686e95238c735fe8c336581bae1483642206882e059c567a0df71a6dd7c4ac26db7a7b02ceb2288c626f5bcf01070c2afbc21c1c43c051d8b894b"
    "8d44de727dbeb2bab466f3f1a0e7f9e8db72e7014adc6407d1e6cf27a078a0ecf35cc230f109b9b6febea4f045685937351667b4f9c5d203ac57a2b"
    "6192da66752008cbe46e4b9a4d1adcd5c738939da73dd4e98c81244e77c304fd3814e151905ab6499c76ccb290d3cc9fa2f41bd00139140b7206e31"
    "ff9d98e4beef1d1a2e20bbc4a225773b9327590503729e589420b1a75d86eaabff22d7ceb0a3bce7985ac4ce86e36c57c1716dc9c7e103b2ad5a424"
    "a8d0e86dfa17f9a07f14c15f27786cf12634f558dfaa6ce453f59f8979c8074dc2d71caa32c0f8973bfbdb27a0765ad68cb53652d2f8db7bd6493db"
    "33cb2472f5ffdce5d48ef09b4501003b70e0f308cfb54c2406a751d4a6ebfabe5dd56ab1e7961b17533c47b52d87f9058889827b5acbe2e37add89e"
    "f335847a82ff96bf48ebac0a33a2030ca4727540461afa9d826f281a40eb8ffc237f333ef6e6ece6967e5b43aee80e8a8b8025c0c86d7f0f0f49db9"
    "7b5d021d155cfb260be07c9de8546c0b472011b8aeba10e92f6aa0c78fe0fc3671d25e32711524fe1d467f072666a22af80f3e7a6c8c750d2fbe6a6"
    "23807a8ceba82ec7f47fddca38e09f14c86b97cb189f3de0ca445207dd36ec4f9e2ee7b905bad8a8ba4a231f6639e536cba5de790c015fbbe9b353e"
    "f02b5f59236461d4a27ed783b71a7159690ead016d692e6e266eed01663a0749f361c71c184287308e1b63eb4d3d07b4f0ee99b3cdb83b2bae999c3"
    "6335e5346f2a697bf7b198a6b933d8b68111f5adee2a1c09c8c572647fd9547f6eafd6e33a33b9adc8d1999c1efc6925e28a38ec2f40a7011aed4a5"
    "633e3efacacace2ebc213475edb6683dd5d8bb078116e95790fbcbb3926d999f256bc2f2ab1bbe1ddbda1d8caf3e1c565bd3d72665ba7acabc843fc"
    "bf50f723c940b6c76657515b347ddf9eaa50b0a79749430145a6491ea04b932fad174e2c3ba25099cdf2ff6fb93e59312a2391582fa6301d039ad6c"
    "b34be631295a583d696acdf81f60aef2933d103a4f6838dc8a34267a4bc34f96ba701316325e7166e9d994eaafae1a36114b99fc77cd003b826a4eb"
    "3284fb97de0abe331c71e30d7222190ed1ceb320a5ed360e3a57c6a463584b084abaf01f219c95d313f0fcdf7bab652d60ac5acc485c8523ac95045"
    "0547521bda5b2c27b2601fff9819f522c33cfe86bb34c74ea7ae6883d5641c0e8d1ea150a9bc152f99c900a4edfbeb2890672ea92438561f2f71ca2"
    "104a10cd5d87940cdea1ced6c5e2defa8b9644e70567b6d936558932973a6fc45139615328d9fc2e98b01f548310dcee3a06fb5cd779d971d9e1529"
    "e35d292175fbe0330beca4ba37cc6546b6b28908f7b4316fb7f6057d16b31b1d316c3d00b89706a6cf8485867ccb90862a2966a30e554806b520de4"
    "e7c7c0aa3a2c19e530946de5d28a449caa8c5b81764ecdcf19accd7b52b07200cd0b0315353fe109154eea955dfdbe2654141c735aa6ab2f73fd006"
    "59f5205dad59eb789fa9ed7256400051b95890f87bd2c40141f96e2680363e615da41fae93c46bded9027fc9d988b081c1fa41733d1cb96576663a9"
    "18a03737543944c72d0f9f3d8b89ec4c18711efb791a83505aa6f1a11c2b5c94003c53c3515d17dd152e2dd2f1a3d3a80f13cde03556071dd64dc86"
    "fb138f61cb94ac31779c34bff3e4fea99e4b437b052d7e7df460020128ab5d51901191202780352b140683f662a6dc400ab3b5f623885726773ddf3"
    "b1fddcf2417239c7d5618b41c20d4bae9e4b9f7ab31d12797c1f9d695e81fde8954ce1ee92438e6f0edfead7615cf3d35e2411f428fac882cdadd0d"
    "e55b5ea24d47c7ddaf7c9777d1804a4e2f694e1de128ed042d6477132ea165e3a0b04a053970d135946bc0b2744172764d08dfb086c0b4e371d146f"
    "9ecea3c4467adcec94cda50e6c6d186726421bc7c86bfd18a09a5de4410e52b09bc6ac9bc1165e890d49fc01ed8002708cb4900ac35ab512cccc825"
    "d48b2e2a1fb4db682fcb85b6a0e30b20530a78e90261c922bb7454b864a00f7e977083975b4354d61f310c8465268a3dcb7b32750ca885fe484b7ec"
    "3b2b6951016952d06fec3b4ee653df982c61fd2dba71828eedfb7c8641951e8c2941fe6b6adb703cfb832eb8243e6c0a152b804c6034e849965ed25"
    "da4b495819fc758171e9464fe89dafda64b487d1f75da867fdb2809e2d4b1a454a69117e7b90cb253558f3cb040b4f4fdeb51eda747eb4ec48cc583"
    "58b42f93681f02e2a1ea59f6ccafc83cc4588a3a6f4409d0d80439b705dc2391c09a051cdf1151ae9f01292a17ba440c559481689db00318a1e9aff"
    "10cdcafbbdbc0e5a9d663bdf4f14cfff7d53defec96906b4a3f8584d2df7451b2b52cf81be14071c99bdc94a880fa3520d959a650cce59ef778b0cf"
    "10af2d1b630254d971fa5e37db4f55ed8a84725705d7e4f9905e54a4e24bdc69c5122550e019b1451f642b7c1727544a7875eca6bf30116c5f75c82"
    "6f20c8df8e0e1bc4ba6c84115749a32cd464b7596912e5aed4e3acc77016ade848daafb938d5f7f4744d7adfdccc862df5c8ca239a35a773543764f"
    "1d1a26072c68f516029097636910f24e375120482d2fc6daf35102f7c29bd9813d030d156bd0face37a47937be063b0266760766cd46d835764bdff"
    "25e24df5ed38f32e0d8da21c1c8de4c9ee8a0b7a4f70c08c9efc0ace26aef368b8aa5c34bef19a95ec79f4a17a53cb7b46b03b872e2eeb8d11b6082"
    "48a4bf93910ca8dcbb9ddbb45f6b6f137da120bdd23b2835495bdb293da5f7195f338b604036fc9934315b19b8879243319d62ec6683a4929a57b63"
    "a0e8448039385ad11e6e71250c61bc4e8f0958fc30aa2702eae5209084ab6c5b03c3e178acb187ce8cafacd47717fc1c95e36d0451a59ac29716afc"
    "b1c9b60ae84e1cddf6eb72179718426c7e76996a32f8d3a1c3571406e43c3c92e66a85453bafc09db87a5823738aee33d23d358145b3538e76d4659"
    "e74cd5f5548871e6dd103ba4af5d6ff6f170de073361d9ea751683cba3837e2820de029ed100c52ed286700051b1dc8d94fc887a7e3bf71fe5cae00"
    "dc09e26c5beaf0bb8dc2785524253ac88b3dd7a38a6b53c4b86878140c4747eb4b378c87614243464968d8fa8367d035363bf281bb65c061a410f14"
    "eadab8ae5e838b244f608b14dd4753e3f6a35a8adfe00f08596afd2cf6d473efd2dbfb3be984441cdaa750093612d287688a3322d0e3b2e10907d05"
    "2c51f73a3a04a87eb3fcef9d326f41b475291f018a777139040419001bf78950ce1bd303bc6ff9c350a6afce590b5b70cd637ae1c497718a5cd5178"
    "022f4ae71d85b12d9fcf1766754b3548fef3621b3fb9b21b11e9f902f8cd4e4ef20f0556d5ac48834de84ba0a9cea50416190116c816c9022448436"
    "865636b4e6f6e5a65726f53656e646572151540436865636b5370656356657273696f6e150538436865636b547856657273696f6e15053043686563"
    "6b47656e6573697315160c38436865636b4d6f7274616c697479168106160c28436865636b4e6f6e6365168906152c436865636b576569676874151"
    "5604368617267655472616e73616374696f6e5061796d656e74168d06154850726576616c6964617465417474657374731515104a0f0020706f6c6b"
    "61646f7400000a0c444f54";

extern "C" int LLVMFuzzerTestOneInput(const uint8_t *data, size_t size) {
    if (size > UINT16_MAX || size <= 1) {
        return 0;
    }

    parser_error_t error = parser_unexpected_error;

    uint8_t metadataBuffer[7000] = {0};
    const uint16_t metadataLen =
        parseHexString(metadataBuffer, sizeof(metadataBuffer), metadataPolkadotTreasurySpend.c_str());

    // ById(39) --> Type { path: [], type_def: Array(TypeDefArray { len: 8, type_param: ById(30) }), type_id: 39 },
    const TypeRef_t type = {.index = ById, .byId = 39};
    parser_context_t blob = {.buffer = data, .bufferLen = static_cast<uint16_t>(size), .offset = 0};
    parser_context_t metadata = {.buffer = metadataBuffer, .bufferLen = metadataLen, .offset = 0};
    RegistryEntry_t tmpEntry = {0};
    PrintItem_t printItem = {0};
    printItem.printing = true;
    printItem.target = 1;

    error = parseTypeRef(&blob, &metadata, &tmpEntry, &type, &printItem);
    if (error != parser_ok) {
        return 0;
    }

    return 0;
}
